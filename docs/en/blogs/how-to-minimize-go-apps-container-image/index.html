<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatbile content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Clavin June"><meta http-equiv=content-security-policy content="default-src 'self' 'unsafe-inline' https:; object-src 'none'; style-src 'self' 'unsafe-inline' fonts.googleapis.com github.githubassets.com; font-src fonts.gstatic.com; script-src 'self' 'unsafe-inline' www.googletagmanager.com gist.github.com giscus.app static.cloudflareinsights.com; base-uri 'none'; img-src 'self' images.unsplash.com i.kym-cdn.com iq.opengenus.org;"><meta name=google-site-verification content="n8iUJq2zr7wQ8eTS_ozpypgZQhfezUeUOXhOr3-INrE"><meta name=monetization content="$ilp.uphold.com/RYNmdxrFrPJB"><link rel=me href=mailto:juneardoc@gmail.com><link rel=pingback href=https://webmention.io/clavinjune.dev_en_/xmlrpc><link rel=webmention href=https://webmention.io/clavinjune.dev_en_/webmention><meta name=description content="how to reduce your Golang apps container image size"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="June Personal Web"><meta property="og:title" content="How to Minimize Go Apps Container Image"><meta property="og:description" content="how to reduce your Golang apps container image size"><meta property="og:type" content="article"><meta property="og:url" content="https://clavinjune.dev/en/blogs/how-to-minimize-go-apps-container-image/"><meta property="og:image" content="https://images.unsplash.com/photo-1613690399151-65ea69478674?w=1920&q=50"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2021-11-19T18:46:59+07:00"><meta property="article:modified_time" content="2021-11-19T18:46:59+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1613690399151-65ea69478674?w=1920&q=50"><meta name=twitter:title content="How to Minimize Go Apps Container Image"><meta name=twitter:description content="how to reduce your Golang apps container image size"><title>June Personal Web - How to Minimize Go Apps Container Image</title><link rel=stylesheet href=https://clavinjune.dev/css/style.min.18b5dac8bd8a35f52a3a027a9faec3e09327d0500eb2b1b42cdb8df5f29f8b16.css integrity="sha256-GLXayL2KNfUqOgJ6n67D4JMn0FAOsrG0LNuN9fKfixY="><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@300;400;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@300;400;700&display=swap"></noscript><link rel=preload href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap"></noscript><link rel=stylesheet href=https://clavinjune.dev/css/single.min.e8889c0752ac6ca9337cbb89ec2e249a2f3effd2a56faa77f8307f247d2433dd.css integrity="sha256-6IicB1KsbKkzfLuJ7C4kmi8+/9Klb6p3+DB/JH0kM90="></head><body><nav class=fg-bold><a id=skip-to-content href=#content>Skip to content</a><ul id=menu><li><a href=https://clavinjune.dev/en/>HOME</a></li><li><a class=active href=https://clavinjune.dev/en/blogs/>BLOG</a></li></ul></nav><main class=single><h1 class=title>How to Minimize Go Apps Container Image</h1><div class="metadata font-16"><a class=category href=https://clavinjune.dev/en/categories/tech>tech</a>
<span class=middot>&#183;</span>
<span>Nov 19, 2021</span>
<span class=middot>&#183;</span>
<span>~5 min</span></div><div id=content><figure><div class=img-box><img srcset="https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=240 240w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=300 300w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=360 360w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=480 480w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=600 600w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=768 768w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=800 800w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=960 960w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=1024 1024w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=1080 1080w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=1200 1200w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=1366 1366w,https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=1920 1920w" sizes="(max-width: 200px) 200px, 100vw" src="https://images.unsplash.com/photo-1613690399151-65ea69478674?fm=webp&q=50&w=1920" alt="Photo by @ventiviews on Unsplash" title="Photo by @ventiviews on Unsplash"></div><figcaption class=font-16>Photo by <a class="link unsplash-ref" rel="noreferrer nofollow noopener" target=_blank href=https://unsplash.com/@ventiviews>@ventiviews</a> on Unsplash</figcaption></figure><h2 id=introduction>Introduction</h2><p>Image is one necessary thing that you must plan when you want to containerize your apps. Building a large image means you need more data to transfer between your image repository, CI/CD platform, and deployment server. Creating a smaller container is a must to save time. There&rsquo;s no need to be difficult when it comes to reducing container image size. Especially with Go apps, it has already come with a binary, which means it doesn&rsquo;t need any environmental server like Nginx, Node, Etc.</p><p>In this article, you will learn how to reduce your Go apps container image using Docker. You can also use another builder like Buildah that used by Podman. In this case, you will reduce your container image&rsquo;s size using a <a class=link rel="nofollow noreferrer noopener" href=#multistage-dockerfile>multi-stage build</a> with a <strong>distroless image</strong>, <a class=link rel="nofollow noreferrer noopener" href=#upx-dockerfile>UPX</a>, and especially for Go apps, utilize the <a class=link rel="nofollow noreferrer noopener" href=#utilize-go-flags>ldflags</a>.</p><h2 id=go-apps>Go Apps</h2><p>For example, you have a Go application like below:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a31515>&#34;github.com/julienschmidt/httprouter&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> main() {
</span></span><span style=display:flex><span>    r := httprouter.New()
</span></span><span style=display:flex><span>    r.GET(<span style=color:#a31515>&#34;/&#34;</span>, <span style=color:#00f>func</span>(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
</span></span><span style=display:flex><span>        m := <span style=color:#00f>map</span>[<span style=color:#2b91af>string</span>]<span style=color:#00f>interface</span>{}{
</span></span><span style=display:flex><span>            <span style=color:#a31515>&#34;time&#34;</span>: time.Now().UnixMilli(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        w.Header().Add(<span style=color:#a31515>&#34;Content-Type&#34;</span>, <span style=color:#a31515>&#34;application/json&#34;</span>)
</span></span><span style=display:flex><span>        w.WriteHeader(http.StatusOK)
</span></span><span style=display:flex><span>        json.NewEncoder(w).Encode(m)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fmt.Println(<span style=color:#a31515>&#34;Run on port :8000&#34;</span>)
</span></span><span style=display:flex><span>    http.ListenAndServe(<span style=color:#a31515>&#34;:8000&#34;</span>, r)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Import the <a class=link rel="nofollow noreferrer noopener" target=_blank href=https://github.com/julienschmidt/httprouter>httprouter</a> to help simulate the <code>go mod download</code> command inside the <code>Dockerfile</code>/<code>Containerfile</code>.</p><h2 id=initial-dockerfile>Initial Dockerfile</h2><p>Let&rsquo;s say here is your initial Dockerfile content:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#00f>FROM</span><span style=color:#a31515> golang:1.17.3-alpine3.14</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>WORKDIR</span><span style=color:#a31515> /app</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>ENV</span> GO111MODULE=on CGO_ENABLED=0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>COPY</span> go.mod go.sum /app/<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go mod download<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>COPY</span> . .<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go build -o /app/main /app/main.go<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>CMD</span> [ <span style=color:#a31515>&#34;/app/main&#34;</span> ]<span>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>Tips: You can optionally use an alpine image to reduce your base image to save data. And utilize the builder cache by properly putting the line that changes less often earlier.</p></blockquote><p>Let&rsquo;s build and tag it as <code>example:initial</code>.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker build -t example:initial .
</span></span><span style=display:flex><span>$ docker images example
</span></span><span style=display:flex><span>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>example      initial   0d1bfb281019   37 seconds ago   337MB
</span></span></code></pre></td></tr></table></div></div><p>It takes <strong>337MB</strong>, let&rsquo;s improve it.</p><h2 id=multistage-dockerfile>Multistage Dockerfile</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:green># base image</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>FROM</span><span style=color:#a31515> golang:1.17.3-alpine3.14 as base</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>WORKDIR</span><span style=color:#a31515> /builder</span><span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>ENV</span> GO111MODULE=on CGO_ENABLED=0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>COPY</span> go.mod go.sum /builder/<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go mod download<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>COPY</span> . .<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go build -o /builder/main /builder/main.go<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:green># runner image</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>FROM</span><span style=color:#a31515> gcr.io/distroless/static:latest</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>WORKDIR</span><span style=color:#a31515> /app</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>COPY</span> --from=base /builder/main main<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>EXPOSE</span><span style=color:#a31515> 8000</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>CMD</span> [<span style=color:#a31515>&#34;/app/main&#34;</span>]<span>
</span></span></span></code></pre></td></tr></table></div></div><p>Multistage build helps you to leave all the unimportant things inside the base image and start using a new image to run your apps.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#00f>FROM</span><span style=color:#a31515> golang:1.17.3-alpine3.14 as base</span><span>
</span></span></span></code></pre></td></tr></table></div></div><p>As you see, you can name your stages so if you want to copy things from that stage, you can provide the stage&rsquo;s name on the <code>COPY</code> line.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span>...<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:green># runner image</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>FROM</span><span style=color:#a31515> gcr.io/distroless/static:latest</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>WORKDIR</span><span style=color:#a31515> /app</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>COPY</span> --from=base /builder/main main<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>EXPOSE</span><span style=color:#a31515> 8000</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>CMD</span> [<span style=color:#a31515>&#34;/app/main&#34;</span>]<span>
</span></span></span></code></pre></td></tr></table></div></div><p>Also, you can use a <a class=link rel="nofollow noreferrer noopener" target=_blank href=https://github.com/GoogleContainerTools/distroless/>distroless image</a> as your runner image to make your container image smaller. It is also available for some other programming languages. According to its documentation:</p><blockquote><p>&ldquo;Distroless&rdquo; images contain only your application and its runtime dependencies. They do not contain package managers, shells or any other programs you would expect to find in a standard Linux distribution.</p></blockquote><p>As for the example you use <code>CGO_ENABLED=0</code> flags, you can use the <code>gcr.io/distroless/static</code> as a runner image. But if you need the flags to be on, you should use <code>gcr.io/distroless/base</code> referring to the <a class=link rel="nofollow noreferrer noopener" target=_blank href=https://github.com/GoogleContainerTools/distroless/blob/main/base/README.md#image-contents>docs</a>.</p><p>Let&rsquo;s build again and tag it as <code>example:multistage</code>.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker build -t example:multistage .
</span></span><span style=display:flex><span>$ docker images example
</span></span><span style=display:flex><span>REPOSITORY   TAG          IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>example      multistage   6c54eb031f69   2 seconds ago    8.63MB
</span></span><span style=display:flex><span>example      initial      0d1bfb281019   20 minutes ago   337MB
</span></span></code></pre></td></tr></table></div></div><p>Do we have room to be improved? Of course!</p><h2 id=upx-dockerfile>UPX Dockerfile</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style=background-color:#e5e5e5><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style=background-color:#e5e5e5><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:green># base image</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>FROM</span><span style=color:#a31515> golang:1.17.3-alpine3.14 as base</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>WORKDIR</span><span style=color:#a31515> /builder</span><span>
</span></span></span><span style=display:flex;background-color:#e5e5e5><span><span></span><span style=color:#00f>RUN</span> apk add upx<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>ENV</span> GO111MODULE=on CGO_ENABLED=0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>COPY</span> go.mod go.sum /builder/<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go mod download<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>COPY</span> . .<span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go build -o /builder/main /builder/main.go<span>
</span></span></span><span style=display:flex;background-color:#e5e5e5><span><span></span><span style=color:#00f>RUN</span> upx -9 /builder/main<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:green># runner image</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>FROM</span><span style=color:#a31515> gcr.io/distroless/static:latest</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>WORKDIR</span><span style=color:#a31515> /app</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>COPY</span> --from=base /builder/main main<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>EXPOSE</span><span style=color:#a31515> 8000</span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>CMD</span> [<span style=color:#a31515>&#34;/app/main&#34;</span>]<span>
</span></span></span></code></pre></td></tr></table></div></div><p><a class=link rel="nofollow noreferrer noopener" target=_blank href=https://upx.github.io/>UPX</a> is a tool to help you shrink your binary size, not only specific for Go apps. You can install the <code>UPX</code> on line 4, and run the <code>UPX</code> command on line 13 to utilize the builder cache. <code>upx -9</code> means you want to compress better, you can see the available flags by using <code>upx -h</code>.</p><p>Let&rsquo;s build again and tag it as <code>example:with-upx</code>.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker build -t example:with-upx .
</span></span><span style=display:flex><span>$ docker images example
</span></span><span style=display:flex><span>REPOSITORY   TAG          IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>example      with-upx     0831b4ee8d1a   2 seconds ago    5.91MB
</span></span><span style=display:flex><span>example      multistage   6c54eb031f69   12 minutes ago   8.63MB
</span></span><span style=display:flex><span>example      initial      0d1bfb281019   33 minutes ago   337MB
</span></span></code></pre></td></tr></table></div></div><p>Not bad, isn&rsquo;t it? Let&rsquo;s do the final touch.</p><h2 id=utilize-go-flags>Utilize Go Flags</h2><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span>...<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#00f>RUN</span> go build <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    -ldflags <span style=color:#a31515>&#34;-s -w&#34;</span> <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    -o /builder/main /builder/main.go<span>
</span></span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span>...<span>
</span></span></span></code></pre></td></tr></table></div></div><p>Using your last <a class=link rel="nofollow noreferrer noopener" href=#upx-dockerfile>Dockerfile</a>, you only need to retouch the <code>go build</code> command. Add the <code>-ldflags "-s -w"</code> flags to disable the symbol table and DWARF generation that is supposed to create debugging data. You can see the other available options using the <code>go tool link -h</code> command.</p><p>Let&rsquo;s build and tag it as <code>example:latest</code>.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker build -t example:latest .
</span></span><span style=display:flex><span>$ docker images example
</span></span><span style=display:flex><span>REPOSITORY   TAG          IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>example      latest       fd81bd6268bd   1 second ago     4.16MB
</span></span><span style=display:flex><span>example      with-upx     0831b4ee8d1a   9 minutes ago    5.91MB
</span></span><span style=display:flex><span>example      multistage   6c54eb031f69   22 minutes ago   8.63MB
</span></span><span style=display:flex><span>example      initial      0d1bfb281019   42 minutes ago   337MB
</span></span></code></pre></td></tr></table></div></div><p>There you have a minimalist Go apps container image with a significant reduction.</p><h2 id=conclusion>Conclusion</h2><p>You can also use the steps in this article to build another container image besides Go apps. Especially the multistage build that reduce more than half of the image size. But still, only you know what&rsquo;s best and fit for you.</p><p>Thank you for reading!</p></div><div class=separator><span>&#183;</span>
<span>&#183;</span>
<span>&#183;</span></div><h2 class=subtitle>Love This Content?</h2><div class="fg-light support-me">Any kind of supports is greatly appreciated! Kindly support me via <a rel="noreferrer noopener" target=_blank class="fg-bold bottom-red" href=https://www.blockchain.com/btc/address/17Afj6o7xm3ZxQ38adnvSFHSBKhHiCDiev>Bitcoin</a>, <a rel="noreferrer noopener" target=_blank class="fg-bold bottom-red" href=https://ko-fi.com/clavinjune>Ko-fi</a>, <a rel="noreferrer noopener" target=_blank class="fg-bold bottom-red" href=https://trakteer.id/clavinjune>Trakteer</a>, or just continue to read another content. You can write a response via <a class="fg-bold bottom-red" rel="noreferrer nofollow noopener" href=https://webmention.io/ target=_blank>Webmention</a> and let me know the URL via <a class="fg-bold bottom-red" rel="noreferrer nofollow noopener" href=https://telegraph.p3k.io/send-a-webmention target=_blank>Telegraph</a>.</div><div id=webmentions></div><script defer type=text/javascript src=https://clavinjune.dev/js/webmention.js></script><h2 class=subtitle>Drop Your Comment Below</h2><script defer src=https://giscus.app/client.js data-repo=ClavinJune/ClavinJune.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNTUyMjU5NTU=" data-category=General data-category-id=DIC_kwDOCUCPY84B_g1a data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=light crossorigin=anonymous async></script></main><script type=text/javascript src=https://clavinjune.dev/js/ga.js defer></script>
<script defer src="https://www.googletagmanager.com/gtag/js?id=G-MTSJ0LHJ06"></script><footer>Copyright &copy; 2022 &#183; Clavin June</footer><script defer type=text/javascript src=https://clavinjune.dev/js/copy.js></script></body></html>