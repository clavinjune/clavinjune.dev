<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatbile content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Clavin June"><meta http-equiv=content-security-policy content="default-src 'self' 'unsafe-inline' https:; object-src 'none'; style-src 'self' 'unsafe-inline' fonts.googleapis.com github.githubassets.com; font-src fonts.gstatic.com; script-src 'self' 'unsafe-inline' www.googletagmanager.com gist.github.com giscus.app static.cloudflareinsights.com; base-uri 'none'; img-src 'self' images.unsplash.com i.kym-cdn.com iq.opengenus.org;"><meta name=google-site-verification content="n8iUJq2zr7wQ8eTS_ozpypgZQhfezUeUOXhOr3-INrE"><meta name=monetization content="$ilp.uphold.com/RYNmdxrFrPJB"><link rel=me href=mailto:juneardoc@gmail.com><link rel=pingback href=https://webmention.io/clavinjune.dev_en_/xmlrpc><link rel=webmention href=https://webmention.io/clavinjune.dev_en_/webmention><meta name=description content="handle database credential rotation in golang"><meta property="og:locale" content="en_US"><meta property="og:site_name" content="June Personal Web"><meta property="og:title" content="Handle Database Credential Rotation in Golang"><meta property="og:description" content="handle database credential rotation in golang"><meta property="og:type" content="article"><meta property="og:url" content="https://clavinjune.dev/en/blogs/handle-database-credential-rotation-in-golang/"><meta property="og:image" content="https://images.unsplash.com/photo-1559402900-f5e7feea8679?w=1920&q=50"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2022-08-29T16:30:58+07:00"><meta property="article:modified_time" content="2022-08-29T16:30:58+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1559402900-f5e7feea8679?w=1920&q=50"><meta name=twitter:title content="Handle Database Credential Rotation in Golang"><meta name=twitter:description content="handle database credential rotation in golang"><title>June Personal Web - Handle Database Credential Rotation in Golang</title><link rel=stylesheet href=https://clavinjune.dev/css/style.min.896a9b28dba5a8078d3751b90faf73715894e2373c5c5594ab084cc33d6d4527.css integrity="sha256-iWqbKNulqAeNN1G5D69zcViU4jc8XFWUqwhMwz1tRSc="><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@300;400;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@300;400;700&display=swap"></noscript><link rel=preload href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap"></noscript><link rel=stylesheet href=https://clavinjune.dev/css/single.min.e8889c0752ac6ca9337cbb89ec2e249a2f3effd2a56faa77f8307f247d2433dd.css integrity="sha256-6IicB1KsbKkzfLuJ7C4kmi8+/9Klb6p3+DB/JH0kM90="></head><body><nav class=fg-bold><a id=skip-to-content href=#content>Skip to content</a><ul id=menu><li><a href=https://clavinjune.dev/en/>HOME</a></li><li><a class=active href=https://clavinjune.dev/en/blogs/>BLOG</a></li></ul></nav><main class=single><h1 class=title>Handle Database Credential Rotation in Golang</h1><div class="metadata font-16"><a class=category href=https://clavinjune.dev/en/categories/tech>tech</a>
<span class=middot>&#183;</span>
<span>Aug 29, 2022</span>
<span class=middot>&#183;</span>
<span>~5 min</span></div><div id=content><figure><div class=img-box><img srcset="https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=240 240w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=300 300w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=360 360w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=480 480w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=600 600w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=768 768w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=800 800w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=960 960w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=1024 1024w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=1080 1080w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=1200 1200w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=1366 1366w,https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=1920 1920w" sizes="(max-width: 200px) 200px, 100vw" src="https://images.unsplash.com/photo-1559402900-f5e7feea8679?fm=webp&q=50&w=1920" alt="Photo by @picoftasty on Unsplash" title="Photo by @picoftasty on Unsplash"></div><figcaption class=font-16>Photo by <a class="link unsplash-ref" rel="noreferrer nofollow noopener" target=_blank href=https://unsplash.com/@picoftasty>@picoftasty</a> on Unsplash</figcaption></figure><h2 id=introduction>Introduction</h2><p>Many of you might have heard of the database credential rotation. It is a common solution for securing your database. Many providers have implemented this solution such as Hashicorp Vault, AWS Secret Manager, etc. By automatically rotating your database credential, no one can really know how to connect to the database. Indeed it is secure, but it leads to another problem. By rotating your database credential, your application might not be able to connect to the database after some times. Especially when you declare your database maximum connection lifetime. In this article, you will learn how to rotate your database credential programmatically in golang.</p><h2 id=custom-driver>Custom Driver</h2><p>To implement this rotator as a generic solution, you will need to create a <code>customDriver struct</code> which holds your base database driver (e.g postgres, sqlite3, mysql, etc) and a <code>Fetcher interface</code> which will be used to fetch the database credential.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>type</span> Fetcher <span style=color:#00f>interface</span> {
</span></span><span style=display:flex><span>	Fetch() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>type</span> FetcherFunc <span style=color:#00f>func</span>() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>)
</span></span><span style=display:flex><span><span style=color:#00f>func</span> (f FetcherFunc) Fetch() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#00f>return</span> f()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>// customDriver implements the `sql.Driver` interface.
</span></span></span><span style=display:flex><span><span style=color:green></span><span style=color:#00f>type</span> customDriver <span style=color:#00f>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:green>// base is the base database driver
</span></span></span><span style=display:flex><span><span style=color:green></span>	base      driver.Driver
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:green>// fetcherFn is the function that will be used to fetch the database credential
</span></span></span><span style=display:flex><span><span style=color:green></span>	fetcherFn FetcherFunc
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> (d *customDriver) Open(_ <span style=color:#2b91af>string</span>) (driver.Conn, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:green>// fetch the database credential
</span></span></span><span style=display:flex><span><span style=color:green></span>	dsn, err := d.fetcherFn()
</span></span><span style=display:flex><span>	<span style=color:#00f>if</span> err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#00f>return</span> <span style=color:#00f>nil</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>// open the database connection using the fetched credential and base driver
</span></span></span><span style=display:flex><span><span style=color:green></span>	<span style=color:#00f>return</span> d.base.Open(dsn)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=register-the-driver-and-open-the-connection>Register the Driver and Open the Connection</h2><p>Now to be able to use the driver, you need to register the driver and open the connection.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>func</span> OpenWithRotator(name <span style=color:#2b91af>string</span>, base driver.Driver, fetcher Fetcher) (*sql.DB, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>	sql.Register(name, &amp;customDriver{
</span></span><span style=display:flex><span>		base:      base,
</span></span><span style=display:flex><span>		fetcherFn: fetcher.Fetch,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>// you don&#39;t need to fill the dsn, it will be fetched from the fetcher.
</span></span></span><span style=display:flex><span><span style=color:green></span>	<span style=color:#00f>return</span> sql.Open(name, <span style=color:#a31515>&#34;&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=implement-fetcher-interface>Implement Fetcher Interface</h2><p>Let&rsquo;s implement the <code>Fetcher interface</code> by using a simple function. Let&rsquo;s assume that you want to connect to a different database for every time your database lifetime is up.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>var</span> counter <span style=color:#2b91af>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> simpleFetcher() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>	log.Println(<span style=color:#a31515>&#34;fetcher called&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:green>// add your custom logic
</span></span></span><span style=display:flex><span><span style=color:green></span>	<span style=color:green>// e.g. fetching from vault / config / etc.
</span></span></span><span style=display:flex><span><span style=color:green></span>
</span></span><span style=display:flex><span>	counter++
</span></span><span style=display:flex><span>	<span style=color:#00f>return</span> fmt.Sprintf(<span style=color:#a31515>&#34;file:foobar-%d.sqlite&#34;</span>, counter), <span style=color:#00f>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=open-the-connection-with-rotator>Open the Connection with Rotator</h2><p>Open and set the maximum lifetime of the connection to 2 seconds. <code>simpleFetcher</code> will be called every 2 seconds.</p><blockquote><p>If your database credential is rotated faster than your connection lifetime, Golang still can use the old connection.</p></blockquote><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:green>// you can adjust the `&amp;sqlite3.SQLiteDriver{}` accordingly (e.g. &amp;pq.Driver{}, etc.)
</span></span></span><span style=display:flex><span><span style=color:green></span>db, err := OpenWithRotator(<span style=color:#a31515>&#34;foobar&#34;</span>, &amp;sqlite3.SQLiteDriver{}, FetcherFunc(simpleFetcher))
</span></span><span style=display:flex><span><span style=color:#00f>if</span> err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>    log.Fatal(err)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#00f>defer</span> db.Close()
</span></span><span style=display:flex><span>db.SetConnMaxLifetime(2 * time.Second)
</span></span></code></pre></td></tr></table></div></div><h2 id=test-the-connection>Test the Connection</h2><p>To simply test whether the connection is working, you can use the <code>Ping</code> method every second.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>for</span> <span style=color:#00f>range</span> time.Tick(time.Second) {
</span></span><span style=display:flex><span>    <span style=color:#00f>if</span> err := db.Ping(); err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>        log.Fatal(err)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Now when you run the program, you will see the following output:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ go run .
</span></span><span style=display:flex><span>2022/08/29 16:56:16 fetcher called
</span></span><span style=display:flex><span>2022/08/29 16:56:19 fetcher called
</span></span><span style=display:flex><span>2022/08/29 16:56:22 fetcher called
</span></span><span style=display:flex><span>2022/08/29 16:56:25 fetcher called
</span></span><span style=display:flex><span>2022/08/29 16:56:28 fetcher called
</span></span><span style=display:flex><span>2022/08/29 16:56:31 fetcher called
</span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s the sqlite3 database files:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ls | grep foobar-
</span></span><span style=display:flex><span>foobar-1.sqlite
</span></span><span style=display:flex><span>foobar-2.sqlite
</span></span><span style=display:flex><span>foobar-3.sqlite
</span></span><span style=display:flex><span>foobar-4.sqlite
</span></span><span style=display:flex><span>foobar-5.sqlite
</span></span><span style=display:flex><span>foobar-6.sqlite
</span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s the full code:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00f>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a31515>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a31515>&#34;database/sql/driver&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a31515>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a31515>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a31515>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a31515>&#34;github.com/mattn/go-sqlite3&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>type</span> Fetcher <span style=color:#00f>interface</span> {
</span></span><span style=display:flex><span>	Fetch() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>type</span> FetcherFunc <span style=color:#00f>func</span>() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>)
</span></span><span style=display:flex><span><span style=color:#00f>func</span> (f FetcherFunc) Fetch() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#00f>return</span> f()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green>// customDriver implements the `sql.Driver` interface.
</span></span></span><span style=display:flex><span><span style=color:green></span><span style=color:#00f>type</span> customDriver <span style=color:#00f>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:green>// base is the base database driver
</span></span></span><span style=display:flex><span><span style=color:green></span>	base      driver.Driver
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:green>// fetcherFn is the function that will be used to fetch the database credential
</span></span></span><span style=display:flex><span><span style=color:green></span>	fetcherFn FetcherFunc
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> (d *customDriver) Open(_ <span style=color:#2b91af>string</span>) (driver.Conn, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:green>// fetch the database credential
</span></span></span><span style=display:flex><span><span style=color:green></span>	dsn, err := d.fetcherFn()
</span></span><span style=display:flex><span>	<span style=color:#00f>if</span> err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#00f>return</span> <span style=color:#00f>nil</span>, err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>// open the database connection using the fetched credential and base driver
</span></span></span><span style=display:flex><span><span style=color:green></span>	<span style=color:#00f>return</span> d.base.Open(dsn)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> OpenWithRotator(name <span style=color:#2b91af>string</span>, base driver.Driver, fetcher Fetcher) (*sql.DB, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>	sql.Register(name, &amp;customDriver{
</span></span><span style=display:flex><span>		base:      base,
</span></span><span style=display:flex><span>		fetcherFn: fetcher.Fetch,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green>// you don&#39;t need to fill the dsn, it will be fetched from the fetcher.
</span></span></span><span style=display:flex><span><span style=color:green></span>	<span style=color:#00f>return</span> sql.Open(name, <span style=color:#a31515>&#34;&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>var</span> counter <span style=color:#2b91af>int</span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> simpleFetcher() (<span style=color:#2b91af>string</span>, <span style=color:#2b91af>error</span>) {
</span></span><span style=display:flex><span>	log.Println(<span style=color:#a31515>&#34;fetcher called&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:green>// add your custom logic
</span></span></span><span style=display:flex><span><span style=color:green></span>	<span style=color:green>// e.g. fetching from vault / config / etc.
</span></span></span><span style=display:flex><span><span style=color:green></span>
</span></span><span style=display:flex><span>	counter++
</span></span><span style=display:flex><span>	<span style=color:#00f>return</span> fmt.Sprintf(<span style=color:#a31515>&#34;file:foobar-%d.sqlite&#34;</span>, counter), <span style=color:#00f>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00f>func</span> main() {
</span></span><span style=display:flex><span>	<span style=color:green>// you can adjust the `&amp;sqlite3.SQLiteDriver{}` accordingly (e.g. &amp;pq.Driver{}, etc.)
</span></span></span><span style=display:flex><span><span style=color:green></span>	db, err := OpenWithRotator(<span style=color:#a31515>&#34;foobar&#34;</span>, &amp;sqlite3.SQLiteDriver{}, FetcherFunc(simpleFetcher))
</span></span><span style=display:flex><span>	<span style=color:#00f>if</span> err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>		log.Fatal(err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#00f>defer</span> db.Close()
</span></span><span style=display:flex><span>	db.SetConnMaxLifetime(2 * time.Second)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00f>for</span> <span style=color:#00f>range</span> time.Tick(time.Second) {
</span></span><span style=display:flex><span>		<span style=color:#00f>if</span> err := db.Ping(); err != <span style=color:#00f>nil</span> {
</span></span><span style=display:flex><span>			log.Fatal(err)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion</h2><p>This is the simple implementation of a database rotator. You might want to implement your fetcher accordingly depends on your use case.</p><p>Thank you for reading!</p></div><div class=separator><span>&#183;</span>
<span>&#183;</span>
<span>&#183;</span></div><h2 class=subtitle>Love This Content?</h2><div class="fg-light support-me">Any kind of supports is greatly appreciated! Kindly support me via <a rel="noreferrer noopener" target=_blank class="fg-bold bottom-red" href=https://www.blockchain.com/btc/address/17Afj6o7xm3ZxQ38adnvSFHSBKhHiCDiev>Bitcoin</a>, <a rel="noreferrer noopener" target=_blank class="fg-bold bottom-red" href=https://ko-fi.com/clavinjune>Ko-fi</a>, <a rel="noreferrer noopener" target=_blank class="fg-bold bottom-red" href=https://trakteer.id/clavinjune>Trakteer</a>, or just continue to read another content. You can write a response via <a class="fg-bold bottom-red" rel="noreferrer nofollow noopener" href=https://webmention.io/ target=_blank>Webmention</a> and let me know the URL via <a class="fg-bold bottom-red" rel="noreferrer nofollow noopener" href=https://telegraph.p3k.io/send-a-webmention target=_blank>Telegraph</a>.</div><div id=webmentions></div><script defer type=text/javascript src=https://clavinjune.dev/js/webmention.js></script><h2 class=subtitle>Drop Your Comment Below</h2><script defer src=https://giscus.app/client.js data-repo=clavinjune/clavinjune.dev data-repo-id="MDEwOlJlcG9zaXRvcnkxNTUyMjU5NTU=" data-category=General data-category-id=DIC_kwDOCUCPY84B_g1a data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=light crossorigin=anonymous async></script></main><script type=text/javascript src=https://clavinjune.dev/js/ga.js defer></script>
<script defer src="https://www.googletagmanager.com/gtag/js?id=G-MTSJ0LHJ06"></script><footer>Copyright &copy; 2022 &#183; Clavin June</footer><script defer type=text/javascript src=https://clavinjune.dev/js/copy.js></script></body></html>